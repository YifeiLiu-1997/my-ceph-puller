name: Pull_and_Verify_Ceph
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Pull and Verify
        run: |
          # 1. 拉取镜像
          docker pull --platform linux/arm64 openeuler/ceph:latest
          
          echo "========= 验货环节：检查版本 ========="
          # 2. 强行运行 arm64 镜像检查版本
          docker run --rm --platform linux/arm64 openeuler/ceph:latest ceph -v
          
          echo "========= 验货环节：检查内存页支持 ========="
          # 3. 检查内部二进制文件的编译参数（如果是 16 则是适配 64K，12 则是 4K）
          # 我们尝试读取 ceph-osd 里的 strings 看看有没有 jemalloc 的配置
          docker run --rm --platform linux/arm64 openeuler/ceph:latest ldd /usr/bin/ceph-osd || true
          
          # 4. 压缩导出
          docker tag openeuler/ceph:latest ceph-18.2.7-64k:latest
          docker save ceph-18.2.7-64k:latest | gzip > ceph_arm64_final.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ceph-package
          path: ceph_arm64_final.tar.gz
