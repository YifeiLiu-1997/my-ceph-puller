name: Build_Ceph_From_Base
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Custom Ceph Image
        run: |
          echo "========= 1. 拉取 OpenEuler 24.03 基础系统镜像 (绝对存在) ========="
          docker pull --platform linux/arm64 openeuler/openeuler:24.03-lts
          
          echo "========= 2. 启动容器并安装 Ceph (现场制作) ========="
          # 启动一个容器，在后台运行
          docker run -d --name builder --platform linux/arm64 openeuler/openeuler:24.03-lts sleep 3600
          
          # 更新源并安装 ceph 和 ceph-osd
          # OpenEuler 24.03 的官方源里自带 Ceph 18.x，且是 64k 适配的
          docker exec builder dnf update -y
          docker exec builder dnf install -y ceph ceph-osd ceph-mon ceph-mgr
          
          echo "========= 3. 验货环节 (在容器内检查版本) ========="
          docker exec builder ceph -v
          docker exec builder ceph-osd --version
          
          echo "========= 4. 打包成新镜像 ========="
          # 把装好软件的容器保存为新镜像
          docker commit builder ceph-18.2.7-custom:latest
          
          # 检查大小
          docker images | grep ceph
          
          # 导出
          docker save ceph-18.2.7-custom:latest | gzip > ceph_custom_build.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ceph-custom-package
          path: ceph_custom_build.tar.gz
