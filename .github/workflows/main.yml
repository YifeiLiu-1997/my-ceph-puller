name: Pull_Ceph_Fixed_Tags
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Pull and Verify
        run: |
          # 尝试拉取 22.03-LTS-SP3，这是 openEuler 官方最稳的 Reef 18.2.0 镜像
          # 如果这个还报 404，脚本会自动尝试下一个
          docker pull --platform linux/arm64 openeuler/ceph:22.03-lts-sp3 || \
          docker pull --platform linux/arm64 openeuler/ceph:22.03-lts-sp2 || \
          docker pull --platform linux/arm64 openeuler/ceph:20.03-lts-sp4
          
          echo "========= 验货环节 ========="
          # 找到刚才拉下来的镜像 ID 并运行
          IMG_ID=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n 1)
          docker run --rm --platform linux/arm64 $IMG_ID ceph -v
          
          echo "========= 导出极简包 ========="
          docker tag $IMG_ID ceph-arm64-fixed:latest
          docker save ceph-arm64-fixed:latest | gzip > ceph_slim.tar.gz

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ceph-slim-package
          path: ceph_slim.tar.gz
