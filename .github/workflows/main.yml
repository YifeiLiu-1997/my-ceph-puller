name: Build_Ceph_Fixed_Ultimate
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Custom Ceph Image
        run: |
          echo "========= 1. 拉取基础镜像 ========="
          docker pull --platform linux/arm64 openeuler/openeuler:24.03-lts
          
          echo "========= 2. 启动构建容器 ========="
          docker run -d --name builder --platform linux/arm64 openeuler/openeuler:24.03-lts sleep 3600
          
          echo "========= 3. 安装 Ceph 及其核心依赖 (补齐 udevadm/LVM) ========="
          # 这一步安装的是关键：
          # systemd/udev: 提供 udevadm (识别磁盘核心工具)
          # lvm2: 提供 lvm 卷管理 (OSD 运行基础)
          # ceph-volume: 部署 OSD 的必备脚本
          # smartmontools: 监控硬盘健康
          docker exec builder dnf update -y
          docker exec builder dnf install -y \
            ceph \
            ceph-osd \
            ceph-mon \
            ceph-mgr \
            ceph-volume \
            ceph-common \
            systemd \
            udev \
            lvm2 \
            smartmontools \
            procps-ng \
            e2fsprogs
          
          echo "========= 4. 深度验货 (检查关键工具路径) ========="
          docker exec builder ceph -v
          docker exec builder ceph-osd --version
          docker exec builder which udevadm
          docker exec builder which lvm
          
          echo "========= 5. 打包镜像 ========="
          # 务必确保 tag 清楚
          docker commit builder ceph-18.2.2-fixed-64k:latest
          docker save ceph-18.2.2-fixed-64k:latest | gzip > ceph_fixed_64k.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ceph-fixed-package
          path: ceph_fixed_64k.tar.gz
